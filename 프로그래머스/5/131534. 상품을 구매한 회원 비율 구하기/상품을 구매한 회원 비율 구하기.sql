-- 코드를 입력하세요
# SELECT
#     YEAR(ONLINE_SALE.SALES_DATE) AS YEAR,
#     MONTH(ONLINE_SALE.SALES_DATE) AS MONTH,
#     COUNT(DISTINCT ONLINE_SALE.USER_ID) AS PUCHASED_USERS,
#     ROUND(
#         COUNT(DISTINCT ONLINE_SALE.USER_ID) /
#         (SELECT COUNT(USER_ID)
#         FROM USER_INFO
#         WHERE YEAR(JOINED) = '2021'),1
#         ) AS PUCHASED_RATIO
# FROM ONLINE_SALE JOIN USER_INFO
#     ON ONLINE_SALE.USER_ID = USER_INFO.USER_ID
# WHERE YEAR(USER_INFO.JOINED) = '2021'
# GROUP BY YEAR(ONLINE_SALE.SALES_DATE), MONTH(ONLINE_SALE.SALES_DATE)
# ORDER BY YEAR(ONLINE_SALE.SALES_DATE), MONTH(ONLINE_SALE.SALES_DATE)




WITH FLAGS AS (
    SELECT YEAR(SALES_DATE) AS YEAR, MONTH(SALES_DATE) AS MONTH
        ,U.USER_ID ,IFNULL(SIGN(SUM(SALES_AMOUNT)), 0) AS FLAG
    FROM USER_INFO U LEFT JOIN ONLINE_SALE O ON U.USER_ID = O.USER_ID
    WHERE JOINED LIKE '2021%'
    GROUP BY U.USER_ID, YEAR, MONTH
    ORDER BY U.USER_ID)

, ALL_USERS AS (
    SELECT COUNT(USER_ID) AS ALL_U
    FROM USER_INFO
    WHERE JOINED LIKE '2021%')

SELECT YEAR, MONTH
    , CASE WHEN FLAG = 1 THEN COUNT(USER_ID) ELSE 0 
    END AS PURCHASED_USERS
    , CASE WHEN FLAG = 1 THEN ROUND(COUNT(USER_ID)
        /(SELECT * FROM ALL_USERS), 1) ELSE 0 
    END AS PURCHASED_RATIO
FROM FLAGS
GROUP BY YEAR, MONTH
HAVING YEAR IS NOT NULL
order by YEAR, MONTH